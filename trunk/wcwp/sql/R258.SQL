   select * from         G_S_02024_DAY  a 
WHERE USER_ID
IN (
'89160000878180'            
,'89160000878007'            
,'89160000878136'            
,'89160000878159'            
,'89160000878212'            
,'89160000878281'            
,'89160000878293'            
,'89160000878323'            
,'89160000878855'            
,'89160000878902'            
,'89160000879699'            
,'89160000879705'            
,'89760000859398'            
,'89157332235104'            
,'89157332112431'            
,'89460000857857'            
,'89760000859381'            
,'89160000878376'            
,'89160000878383'            
,'89160000878483'            
,'89160000878497'            
,'89160000878949'            
,'89160000878970'            
,'89160000879035'            
,'89160000879088'            
,'89160000879323'            
,'89160000879346'            
,'89160000879367'            
,'89160000879527'            
,'89160000879573'            
,'89160000879585'            
,'89760000859353'            
,'89160000878345'            
)

TIME_ID	USER_ID	BASE_PKG_ID	CHANNEL_ID	REC_DT	VALID_DT
20111231	89157332235104      	QW_QQT_JC_SL88                	11111115                                	20111231	20120101

select * from G_I_02022_DAY
where user_id = '89157332235104'
AND TIME_ID <= 20111229


TIME_ID	USER_ID	BASE_PKG_ID	VALID_DT
20111229	89157332235104      	QW_QQT_JC_SL388               	20110801


select * from bass2.dwd_product_test_phone_20111229 b 
				where b.USER_ID  = '89157332235104'
				and b.sts = 1
null


				



        select count(distinct a.user_id) VALID_CNT,count(distinct b.user_id ) REC_CNT, count(distinct b.user_id )*1.00/count(distinct a.user_id) RATE
        from 
        (
        select * from   
        G_I_02022_DAY  a
        where time_id = 20120103 
	except 
	select * from   
        G_I_02022_DAY  a
        where time_id = 20120102
        ) a
        left join (
                        select a.user_id,value(b.new_pkg_id,a.BASE_PKG_ID) BASE_PKG_ID 
                from (
                        select  USER_ID,BASE_PKG_ID from 
                        G_S_02024_DAY a
                     ) a 
                left join bass1.DIM_QW_QQT_PKGID b on a.BASE_PKG_ID = b.old_pkg_id
                ) b on a.USER_ID = b.USER_ID and a.BASE_PKG_ID= b.BASE_PKG_ID
        with ur
	
	
	
----------------------------------------------------------------------------------------------------------


20120830:

   20120830 R258_3                220.00000            211.00000              0.95909              0.00000
   

select count(distinct a.user_id) VALID_CNT,count(distinct b.user_id ) REC_CNT
        , count(distinct b.user_id )*1.00/count(distinct a.user_id) RATE
        from 
        (
        select user_id,value(t.NEW_PKG_ID,a.BASE_PKG_ID) BASE_PKG_ID,VALID_DT from   
        G_I_02022_DAY  a
        left join bass1.DIM_QW_QQT_PKGID t on a.BASE_PKG_ID = t.old_pkg_id
        where time_id = 20120830
        except 
        select user_id,value(t.NEW_PKG_ID,a.BASE_PKG_ID) BASE_PKG_ID,VALID_DT from   
        G_I_02022_DAY  a
                left join bass1.DIM_QW_QQT_PKGID t on a.BASE_PKG_ID = t.old_pkg_id
        where time_id = 20120829
        ) a
        left join (
                        select a.user_id,value(b.new_pkg_id,a.BASE_PKG_ID) BASE_PKG_ID 
                from (
                        select  USER_ID,BASE_PKG_ID from 
                        G_S_02024_DAY a
                     ) a 
                left join bass1.DIM_QW_QQT_PKGID b on a.BASE_PKG_ID = b.old_pkg_id
                ) b on a.USER_ID = b.USER_ID and a.BASE_PKG_ID= b.BASE_PKG_ID
        with ur
		

        select user_id,value(t.NEW_PKG_ID,a.BASE_PKG_ID) BASE_PKG_ID,VALID_DT from   
        G_I_02022_DAY  a
        left join bass1.DIM_QW_QQT_PKGID t on a.BASE_PKG_ID = t.old_pkg_id
        where time_id = 20120830
        except 
        select user_id,value(t.NEW_PKG_ID,a.BASE_PKG_ID) BASE_PKG_ID,VALID_DT from   
        G_I_02022_DAY  a
                left join bass1.DIM_QW_QQT_PKGID t on a.BASE_PKG_ID = t.old_pkg_id
        where time_id = 20120829
		
USER_ID              BASE_PKG_ID                    VALID_DT
-------------------- ------------------------------ --------
89160001874089       999914211030058001             20120215
89160002518401       999914211030058001             20120830
89160002518558       999914211030058001             20120830
89260002517564       999914211030058001             20120830
89460002519289       999914211030058001             20120830
89660002517828       999914211030058001             20120830
89160002517219       999914211030088001             20120830
89160002517521       999914211030088001             20120830
89160002517749       999914211030088001             20120830
89160002518095       999914211030088001             20120830
89260002518341       999914211030088001             20120830
89460002518531       999914211030088001             20120830
89560002517575       999914211030088001             20120830
89660002517959       999914211030088001             20120830
89760002518787       999914211030088001             20120830
89160002517504       999914211030128001             20120830
89160002518976       999914211030128001             20120830
89760002517491       999914211030128001             20120830
89160001874057       999914211030058001             20120215
89160002517235       999914211020088001             20120830
89160002518034       999914211020088001             20120830
89160002517682       999914211030058001             20120830
89760002518284       999914211030058001             20120830
89160002517430       999914211030088001             20120830
89160002519225       999914211030088001             20120830
89160002519520       999914211030088001             20120830
89460002518678       999914211030088001             20120830
89560002518287       999914211030088001             20120830
89160002517627       999914211030128001             20120830
89260002517993       999914211030128001             20120830
89460002519096       999914211030128001             20120830
89660002519672       999914211030128001             20120830
89160002517761       999914211020058001             20120830
89160002518222       999914211030058001             20120830
89660002517571       999914211030058001             20120830
89760002519733       999914211030058001             20120830
89160002517473       999914211030088001             20120830
89160002517876       999914211030088001             20120830
89160002518090       999914211030088001             20120830
89160002518419       999914211030088001             20120830
89160002519484       999914211030088001             20120830
89160002518470       999914211030128001             20120830
89160002519499       999914211030128001             20120830
89160002519545       999914211030128001             20120830
89160002519292       999914211030158001             20120830
89160002517757       999914211020058001             20120830
89660002519680       999914211020058001             20120830
89160002517702       999914211030058001             20120830
89160002518270       999914211030058001             20120830
89160002518792       999914211030058001             20120830
89260002517700       999914211030058001             20120830
89460002518552       999914211030058001             20120830
89560002519406       999914211030058001             20120830
89160002517217       999914211030088001             20120830
89160002517917       999914211030088001             20120830
89160002518361       999914211030088001             20120830
89160002518918       999914211030088001             20120830
89160002519256       999914211030088001             20120830
89360002517735       999914211030088001             20120830
89460002517650       999914211030088001             20120830
89560002519107       999914211030088001             20120830
89760002517863       999914211030088001             20120830
89260002517997       999914211030128001             20120830
89660002519321       999914211030128001             20120830
89160002518581       999914211020088001             20120830
89160002519344       999914211030058001             20120830
89660002518661       999914211030058001             20120830
89160002517773       999914211030088001             20120830
89160002518036       999914211030088001             20120830
89160002518038       999914211030088001             20120830
89160002519339       999914211030088001             20120830
89160002519605       999914211030088001             20120830
89260002517802       999914211030088001             20120830
89260002517998       999914211030088001             20120830
89460002518783       999914211030088001             20120830
89460002518956       999914211030088001             20120830
89460002517965       999914211030128001             20120830
89760002518938       999914211030128001             20120830
89160001873980       999914211030058001             20120215
89160002518375       999914211020058001             20120830
89160002518636       999914211020058001             20120830
89260002517860       999914211020088001             20120830
89160002517455       999914211030058001             20120830
89160002518571       999914211030058001             20120830
89160002518732       999914211030058001             20120830
89160002518999       999914211030058001             20120830
89660002519679       999914211030058001             20120830
89760002517794       999914211030058001             20120830
89160002518476       999914211030088001             20120830
89160002518618       999914211030088001             20120830
89160002518936       999914211030088001             20120830
89160002519245       999914211030088001             20120830
89460002517816       999914211030088001             20120830
89460002519222       999914211030088001             20120830
89560002519198       999914211030088001             20120830
89760002518076       999914211030088001             20120830
89160002517234       999914211030128001             20120830
89160001874073       999914211030058001             20120215
89160001874101       999914211030058001             20120215
89160002519269       999914211020088001             20120830
89160002518975       999914211030058001             20120830
89460002519031       999914211030058001             20120830
89660002517598       999914211030058001             20120830
89160002517405       999914211030088001             20120830
89160002518925       999914211030088001             20120830
89160002519581       999914211030088001             20120830
89360002517166       999914211030088001             20120830
89660002518335       999914211030088001             20120830
89660002519380       999914211030088001             20120830
89160002519294       999914211030128001             20120830
89360002518981       999914211030128001             20120830
89160001874009       999914211030058001             20120215
89160001874066       999914211030058001             20120215
89160002517406       999914211020058001             20120830
89160002519072       999914211030058001             20120830
89160002519214       999914211030058001             20120830
89560002519259       999914211030058001             20120830
89660002517974       999914211030058001             20120830
89660002518767       999914211030058001             20120830
89160002517926       999914211030088001             20120830
89160002518853       999914211030088001             20120830
89160002518917       999914211030088001             20120830
89260002518695       999914211030088001             20120830
89760002517340       999914211030088001             20120830
89760002518073       999914211030088001             20120830
89760002519510       999914211030088001             20120830
89760002519824       999914211030088001             20120830
89160002519295       999914211030128001             20120830
89160002518626       999914211030288001             20120830
89160002517346       999914211030058001             20120830
89160002517416       999914211030058001             20120830
89160002518369       999914211030058001             20120830
89160002519117       999914211030058001             20120830
89360002517423       999914211030058001             20120830
89660002517819       999914211030058001             20120830
89660002517973       999914211030058001             20120830
89160002519341       999914211030088001             20120830
89560002517580       999914211030088001             20120830
89560002519346       999914211030088001             20120830
89660002518914       999914211030088001             20120830
89760002517910       999914211030088001             20120830
89160002517464       999914211030128001             20120830
89260002517961       999914211030128001             20120830
89160002518080       999914211030058001             20120830
89160002518868       999914211030058001             20120830
89160002517453       999914211030088001             20120830
89160002517795       999914211030088001             20120830
89160002518736       999914211030088001             20120830
89160002519239       999914211030088001             20120830
89160002519300       999914211030088001             20120830
89560002519196       999914211030088001             20120830
89160001874107       999914211030058001             20120215
89160002518068       999914211020058001             20120830
89160002517213       999914211030058001             20120830
89160002518747       999914211030058001             20120830
89160002518882       999914211030058001             20120830
89160002519076       999914211030058001             20120830
89260002518131       999914211030058001             20120830
89160002518260       999914211030088001             20120830
89160002518892       999914211030088001             20120830
89160002519448       999914211030088001             20120830
89260002518899       999914211030088001             20120830
89360002518424       999914211030088001             20120830
89460002518318       999914211030088001             20120830
89560002517620       999914211030088001             20120830
89760002518262       999914211030088001             20120830
89160002517524       999914211030158001             20120830
89560002518743       999914211030188001             20120830
89160002517701       999914211020088001             20120830
89160002517541       999914211030058001             20120830
89160002517622       999914211030058001             20120830
89160002519237       999914211030058001             20120830
89160002519246       999914211030058001             20120830
89160002517887       999914211030088001             20120830
89160002518416       999914211030088001             20120830
89260002517574       999914211030088001             20120830
89260002518183       999914211030088001             20120830
89460002517522       999914211030088001             20120830
89460002517964       999914211030088001             20120830
89760002519082       999914211030088001             20120830
89160002518974       999914211030128001             20120830
89160002519309       999914211020058001             20120830
89160002517944       999914211020128001             20120830
89160002517853       999914211030058001             20120830
89160002519440       999914211030058001             20120830
89660002517330       999914211030058001             20120830
89160002518093       999914211030088001             20120830
89160002518272       999914211030088001             20120830
89160002518990       999914211030088001             20120830
89360002519094       999914211030088001             20120830
89560002517587       999914211030088001             20120830
89760002518878       999914211030128001             20120830
89160002519503       999914211030158001             20120830
89160001874076       999914211030058001             20120215
89760002519278       999914211020058001             20120830
89160002518959       999914211020088001             20120830
89160002518499       999914211020128001             20120830
89160002517435       999914211030058001             20120830
89160002518142       999914211030058001             20120830
89260002519658       999914211030058001             20120830
89260002519691       999914211030058001             20120830
89560002519315       999914211030058001             20120830
89660002519529       999914211030058001             20120830
89760002517452       999914211030058001             20120830
89160002517886       999914211030088001             20120830
89160002518055       999914211030088001             20120830
89460002518651       999914211030088001             20120830
89760002519100       999914211030088001             20120830
89360002517745       999914211030188001             20120830
89160002518923       999914211030058001             20120830
89260002519913       999914211030058001             20120830
89460002518613       999914211030058001             20120830
89160002518253       999914211030088001             20120830
89160002518370       999914211030088001             20120830
89160002519462       999914211030088001             20120830
89160002519471       999914211030088001             20120830
89260002518163       999914211030088001             20120830
89760002518049       999914211030088001             20120830
89260002519410       999914211030128001             20120830
89160002517218       999914211030188001             20120830

  220 record(s) selected.
  
  
select user_id,BASE_PKG_ID
from (
        select user_id,value(t.NEW_PKG_ID,a.BASE_PKG_ID) BASE_PKG_ID,VALID_DT from   
        G_I_02022_DAY  a
        left join bass1.DIM_QW_QQT_PKGID t on a.BASE_PKG_ID = t.old_pkg_id
        where time_id = 20120830
        except 
        select user_id,value(t.NEW_PKG_ID,a.BASE_PKG_ID) BASE_PKG_ID,VALID_DT from   
        G_I_02022_DAY  a
                left join bass1.DIM_QW_QQT_PKGID t on a.BASE_PKG_ID = t.old_pkg_id
        where time_id = 20120829
		) t 
		except

                select a.user_id,value(b.new_pkg_id,a.BASE_PKG_ID) BASE_PKG_ID 
                from (
                        select  USER_ID,BASE_PKG_ID from 
                        G_S_02024_DAY a
                     ) a 
                left join bass1.DIM_QW_QQT_PKGID b on a.BASE_PKG_ID = b.old_pkg_id


USER_ID              BASE_PKG_ID                   
-------------------- ------------------------------
89160001874073       999914211030058001            
89160001874089       999914211030058001            
89160001874101       999914211030058001            
89160001874066       999914211030058001            
89160001873980       999914211030058001            
89160001874009       999914211030058001            
89160001874057       999914211030058001            
89160001874076       999914211030058001            
89160001874107       999914211030058001            

  9 record(s) selected.
  
以上号码为导致校验不过的原因。

select *from G_S_02024_DAY
where user_id in 
(
 '89160001874073'
,'89160001874089'
,'89160001874101'
,'89160001874066'
,'89160001873980'
,'89160001874009'
,'89160001874057'
,'89160001874076'
,'89160001874107'
)



select *from G_I_02022_DAY
where user_id in 
(
 '89160001874073'
,'89160001874089'
,'89160001874101'
,'89160001874066'
,'89160001873980'
,'89160001874009'
,'89160001874057'
,'89160001874076'
,'89160001874107'
)



select user_id,userstatus_id,test_mark from bass2.dw_product_20120830
where user_id in 
(
 '89160001874073'
,'89160001874089'
,'89160001874101'
,'89160001874066'
,'89160001873980'
,'89160001874009'
,'89160001874057'
,'89160001874076'
,'89160001874107'
)




select user_id,userstatus_id,test_mark from bass2.dw_product_20120829
where user_id in 
(
 '89160001874073'
,'89160001874089'
,'89160001874101'
,'89160001874066'
,'89160001873980'
,'89160001874009'
,'89160001874057'
,'89160001874076'
,'89160001874107'
)

为9个号码由测试转非测试导致！

解决方案：
把这些用户加入到02024 中

create view tv_G_S_02024_DAY_1
as
select distinct 
        20120830 time_id
        ,a.PRODUCT_INSTANCE_ID USER_ID
        ,char(a.offer_id) BASE_PKG_ID
        ,char(a.ORG_ID) CHANNEL_ID
        ,'20120830' REC_DT
        ,'20120830' VALID_DT
from  bass2.Dw_product_ins_off_ins_prod_ds a 
        , bass2.dw_product_20120830 b 
where  a.state =1 
        and a.PRODUCT_INSTANCE_ID=b.user_id 
        and b.usertype_id in (1,2,9) 
        and b.userstatus_id in (1,2,3,6,8)
        and a.valid_type in (1,2)
		and a.PRODUCT_INSTANCE_ID in 
(
 '89160001874073'
,'89160001874089'
,'89160001874101'
,'89160001874066'
,'89160001873980'
,'89160001874009'
,'89160001874057'
,'89160001874076'
,'89160001874107'
)
and  char(a.offer_id) in (
                SELECT char(offer_id) FROM BASS2.dim_prod_up_offer 
                WHERE OFFER_TYPE='OFFER_PLAN'
                and TRADEMARK = 161000000001
        union 
                select char(xzbas_value)  as offer_id 
                from  BASS1.ALL_DIM_LKP 
                where BASS1_TBID = 'BASS_STD1_0114'
                and bass1_value like 'QW_QQT_JC%'
                and XZBAS_COLNAME not like '套餐减半%'
        )
with ur
---

insert into G_S_02024_DAY
select  distinct t.time_id
,t.user_id
,value(b.new_pkg_id ,t.BASE_PKG_ID) BASE_PKG_ID
,t.CHANNEL_ID
,t.REC_DT
,t.VALID_DT
from (
select time_id
        ,a.user_id
        , value(bass1.fn_get_all_dim_ex('BASS_STD1_0114',a.BASE_PKG_ID),a.BASE_PKG_ID) BASE_PKG_ID
        , value(char(b.CHANNEL_ID),'BASS1_DS') CHANNEL_ID
        , a.REC_DT
        , a.VALID_DT
from bass1.tv_G_S_02024_DAY_1 a 
left join (select distinct channel_ID,organize_id from  bass2.dim_channel_info a where a.channel_type_class in (90105,90102) ) b on a.CHANNEL_ID = char(b.organize_id )
where a.base_pkg_id not in (SELECT 
                        distinct XZBAS_VALUE
                FROM BASS1.ALL_DIM_LKP 
                WHERE BASS1_TBID = 'BASS_STD1_0114'
and BASS1_VALUE  not like '%QW%')
) t 
left join bass1.DIM_QW_QQT_PKGID  b on t.BASE_PKG_ID = b.old_pkg_id
with ur

$ db2 "select *from bass1.g_rule_check where rule_code = 'R258_3' order by 1 "
