$ crt_basetab.sh stat_market_channel_key_0133.tcl 2011-07-01
/bassapp/report
#######################

stat_market_channel_key_0133.tcl

2011-07-01

2011-07-01
20110731
07
Select current date - 1 days from dual
2011-08-19
declare global temporary table session.stat_market_channel_key_0133_tmp (
              region_id   varchar(12),
              s_index_id  smallint,
              t_index_id  smallint,
              value       decimal(12,2)
          )
          partitioning key
                (
                  region_id
                ) using hashing
        with replace on commit preserve rows not logged in tbs_user_temp
        
insert into session.stat_market_channel_key_0133_tmp
                 select a.region_id,b.s_index_id,c.t_index_id,0
                 from bassweb.dim_pub_region a,
                      bass2.dim_s_index_key_lkp  b,
                      bass2.dim_t_index_key_lkp c
        
insert into session.stat_market_channel_key_0133_tmp
                   select b.region_id,101,201,count(a.product_instance_id)
                   from 
                      (select product_instance_id
                       from dw_product_ord_cust_dm_201107
                       where channel_type = 'B' ) a,
                       dw_product_201107 b
                    where a.product_instance_id = b.user_id 
                    group by b.region_id
        
insert into session.stat_market_channel_key_0133_tmp
                        select b.region_id,101,202,count(*)
                        from dw_custsvc_ivr_log_dm_201107 a,
                             dw_product_201107 b
                        where a.calling = b.product_no 
                         and b.userstatus_id in (1,2,3,6,8)
                         and a.operation_type<>6
                        group by b.region_id
        
insert into session.stat_market_channel_key_0133_tmp
                select b.region_id,101,203,count(*)
                from 
                        dw_kf_sms_cmd_receive_dm_201107 a,
                                                     dw_product_201107 b
                where a.cmd_id in (     select distinct(cmd_id) 
                                                               from bass2.ODS_SYS_CMD_DEF_20110819
                                                                                                   where sts=0 and cmd_group in(9,10,20,12) 
                                                                                                       and fun_id <>100001 
                                                and cmd_desc not like '%查询%' 
                                                                                                        and cmd_type <>11  ) 
                                                and deal_result=0 
                                                and sts=4 
                                                and region_code <> 999
                                                and a.phone_id = b.product_no 
                                                and b.userstatus_id in (1,2,3,6,8)
                                                and b.usertype_id in (1,2,9)
                                                and a.cmd_id <> 201
                                group by  b.region_id
   
insert into session.stat_market_channel_key_0133_tmp
        select d.region_id,101,204,count(*)
         from dw_product_ord_cust_dm_201107 a,
                      dw_product_ord_busi_dm_201107 b,
                      DW_PRODUCT_ORD_BUSI_OTHER_201107  c,
                                                   dw_product_201107 d
                      where a.customer_order_id = b.customer_order_id
                      and b.busioper_order_id =c.busioper_order_id 
                      and c.ext_6 like '%SRC=206%'   
                                          and a.product_instance_id = d.user_id     
                                group by d.region_id    
   
insert into session.stat_market_channel_key_0133_tmp
        select b.region_id,101,205,count(*)
         from dw_product_ord_cust_dm_201107 a,
              dw_product_201107 b
         where a.product_instance_id = b.user_id
               and  a.channel_type ='9'   
         group by  b.region_id  
   
insert into session.stat_market_channel_key_0133_tmp
                   select c.region_id,104,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 3 then 203
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end ,
                                                                           count(a.product_no)
 from (
select echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,
         sum(flow) flows,product_no
      from (
            select 1 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (
      select 21 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  bass2.dw_custsvc_ivr_log_dm_201107
      where operation_code = '1008611' or operation_code = '20102'
      group by brand, calling
      union all
      select 23 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  bass2.dw_custsvc_ivr_log_dm_201107
      where operation_code = '20106'
      group by brand, calling
      union all
      select 24 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  bass2.dw_custsvc_ivr_log_dm_201107
      where operation_type <> 6
      group by brand, calling
               union all
      select 22 as busi_code_type, case when brand_name like '%全球通%' then 1
               when brand_name like '%动感地带%' then 4 else 5 end as brand_id,
       count(*) as flow, bill_id as product_no
      from  bass2.dw_product_ord_so_log_dm_201107
      where length(trim(char(op_id))) = 4
      and busi_id in (
      select business_id from  DIM_SO_BUSIOPTCODE_MAPPING where opt_name not like '%查询%')
      group by case when brand_name like '%全球通%' then 1
        when brand_name like '%动感地带%' then 4 else 5 end, bill_id
                 )a
            group by busi_code_type,brand_id,product_no
            union all
            select 2 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (select b.parent_ob_id as busi_code_type,a.brand_id,
                      count(1) as flow,a.product_no
                   from  bass2.dw_ow_loading_log_201107 a, dim_sys_object5  b
                   where a.ob_type =1 and b.parent_ob_id in (21,23) and b.check_result = 5 and a.ob_id = b.ob_id
                      and date(a.start_time)>='2011-07-01' and date(a.start_time)<='2011-07-31'
       and (a.is_success in (0,1) or a.err_msg is null
                   or a.err_msg = 'action is null' or a.err_msg = '您当前的营销方案无法变更该促销!'
                   or a.err_msg = '您输入的服务密码校验错误：密码不正确!' or a.err_msg = 'Broken pipe')
                   group by b.parent_ob_id,a.brand_id,a.product_no
                   union all
                   select 22 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  bass2.dw_product_busi_dm_201107 a, bass2.dw_product_201107 b
                   where a.user_id=b.user_id and a.user_id in (
                      select user_id from  bass2.dw_product_201107
                      where product_no in (select product_no from  bass2.dw_ow_loading_log_201107
                                           where is_success in (0,1) and date(start_time)>='2010-12-01' and date(start_time)<'2011-01-01'
                                           ) and userstatus_id>0
                      ) and a.so_mode ='15' and a.op_id=10000475
                      and date(a.so_date)>='2011-07-01' and date(a.so_date)<='2011-07-31'
                   group by b.brand_id,b.product_no
                   union all
                   select 24 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  bass2.dw_acct_payitem_dm_201107 a, bass2.dw_product_201107 b
                   where a.user_id=b.user_id and a.paytype_id in ('4468')
                   group by b.brand_id,b.product_no
                  )a
            group by busi_code_type,brand_id,product_no
            union all
            select 3 as echl_type,busi_code_type,brand_id,phone_id as product_no,sum(flow) as flow
            from (select case when c.result_type in ('CXYE','CXZD','CXZE','CXKCYE') then 21
            else 23 end as busi_code_type, a.brand_id,
             count(1) as flow, b.phone_id
      from  bass2.dw_product_201107 a,  bass2.dw_kf_sms_cmd_receive_dm_201107 b,  bass2.dw_kf_cmd_hint_def_dm_201107 c
      where a.product_no  = b.phone_id and b.cmd_id = c.cmd_id and b.deal_result = c.cmd_result
      and replace(char(c.op_time),'-','') = '20101231' and c.result_jieg in (0)
      and c.result_type in ('CXYE','CXZD','CXZE','CXKCYE','CXJF')
      and a.userstatus_id in (1,2,3,6,8) and a.test_mark <> 1 and a.usertype_id in (1,2,9)
      group by case when c.result_type in ('CXYE','CXZD','CXZE','CXKCYE') then 21
               else 23 end, a.brand_id, b.phone_id
      union all
      select 22 as busi_code_type, a.brand_id,
         count(1) as flow, b.phone_id
      from  bass2.dw_product_201107 a,  bass2.dw_kf_sms_cmd_receive_dm_201107 b,  bass2.dw_kf_cmd_hint_def_dm_201107 c
      where a.product_no  = b.phone_id and b.cmd_id = c.cmd_id and b.deal_result = c.cmd_result
      and replace(char(c.op_time),'-','') = '20110731' and c.result_jieg in (0)
      and c.result_type in (select sms_cmd from stat_ecustsvc_sms_cmd)
      and a.userstatus_id in (1,2,3,6,8) and a.test_mark <> 1 and a.usertype_id in (1,2,9)
      group by a.brand_id, b.phone_id) a
            group by busi_code_type,brand_id,phone_id
            union all
   select 5 as echl_type,22 as busi_code_type,b.brand_id,b.product_no, count(1) as flow
   from  bass2.dw_product_ord_cust_dm_201107 a left join  bass2.dw_product_201107 b on a.product_instance_id=b.user_id
   where channel_type='6' and source_system_id in (3) and business_id=193000000001 and old_so_order_id is null
   group by b.brand_id, b.product_no
            union all
            select 6 as echl_type,24 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  bass2.dw_product_201107 a, bass2.dw_acct_payitem_dm_201107 b
            where a.user_id=b.user_id and b.paytype_id in ('4162','4864') and b.rec_sts=0
            group by a.brand_id,a.product_no
            union all
            select 6 as echl_type,22 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  bass2.dw_product_201107 a, bass2.dw_product_busi_dm_201107 b
            where a.user_id=b.user_id and b.so_mode='5' and b.op_id in (select op_id from  dim_boss_staff where op_name like '%自助%')
            and b.process_id not in (2,3,22,14,24,12,13)
            group by a.brand_id,a.product_no
           )a
      group by echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,product_no ) a,
          (
select b.product_instance_id from bass2.dw_product_ord_srvpkg_dm_201107 a,bass2.dw_product_ord_cust_dm_201107 b
where 1=1 and a.customer_order_id=b.customer_order_id
   and a.servicepkg_id in (
select PRODUCT_ITEM_ID from DIM_PROD_UP_PRODUCT_ITEM a where a.SUPPLIER_ID in ('931067','931067','931067','900119','900140','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900139','900139','900119','900652','900652','900652','900103','900103','900110','900110','900107','900122','900104','900104','900120','900120','900139','900139','900139','900139','900139','900139','900652','900652','900652','900652','900652','900652','900652','900652','900116','900105','900105','900113','900113','900123','900652','900652','900123','900123','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900109','900109','900109','900652','900652','901500','900139','900117','900117','900106','900106','900106','900106','900106','900112','900112','900140','900129','900121','900121','900121','900121','900121','900123','900123','900148','900652','900652','900652','900652','900652','900652','900652','900652','900141','900141','900141','900141','900143','900143','900143','900145','900145','900145','900143','900143','900143','900143','701001','701001','900132','900115','901899','900132','900132','901899','901899','931067','900114','901899','901899','901899','901899','701001','901899','901899','901899','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','701001','701001','701001','901876','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901922','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','900132','901876','901876','901876','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','931078','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901908','900132','900132','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','80001','80001','80001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801187','801187','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','80001','80001','80001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900128','900128','900128','900128','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','98555','931805','801132','801166','801166','801166','801166','801166','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801242','801242','801242','801173','801173','801173','801166','801166','801166','801166','801163','801163','801163','801151','701001','701001','701001','931067','931067','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801151','801151','801151','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801236','801236','801236','801236','801236','901922','901922','801244','801244','801244','801137','801137','801137','801137','801137','801110','801110','801110','801110','801110','801110','801110','801110','801110','801110','801137','801137','801137','801137','801137','801137','801137','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801237','801237','801237','801237','801237','801233','801233','801233','900130','901585','901585','901585','801248','701001','701001','801248','801248','801248','801248','801248','801248','801185','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801187','900520','900520','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901500','701001','701001','701001','701001','701001','801164','801110','900144','900144','900144','701001','701001','931106','931106','931106','701001','801248','801248','801248','801248','801248','901585','901585','901585','801233','801233','801233','801233','801233','801185','801185','801114','801168','801168','801168','801164','801164','900138','900138','701001','701001','701001','701001','701001','701001','701001','801166','900013','900013','900013','900013','900013','900013','900138','900138','900139','900105','900132','900132','900132','900132','900132','900132','801248','801248','801166','801191','801191','801191','400000','400000','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900123','900123','900123','900123','900132','400000','400001','400001','400001','801157','900652','900132','900132','900132','900132','900652','801236','801236','801237','801237','801237','801236','801233','801233','801233','801233','801233','801233','801241','900132','900132','901876','900123','900123','900132','900132','900132','901876','901876','901585','901585','901585','900132','900132','900132','900132','901876','801157','801157','901876','901876','901876','901876','901876','901876','901876','901876','901876','931067','931067','931067','931067','931067','931067','931067','900013','900013','900013','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','931106') and item_type='SERVICE_PRICE')


) b,bass2.dw_product_201107 c
where a.product_no=c.PRODUCT_NO and c.USER_ID=b.PRODUCT_INSTANCE_ID and a.busi_code_type     in (22)
     and c.userstatus_id in (1,2,3,6,8)
                     and c.usertype_id in (1,2,9)
          group by  c.region_id,104,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 3 then 203
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end
        
insert into session.stat_market_channel_key_0133_tmp
                     select a.region_id,105,
                            case when a.class = 4 then 205 
                                 when a.class = 5 then 201
                            else 206 end ,sum(a.amount)
                                 from
                                    ( select a.region_id,
                                            case when b.opt_code in ('4464','4864') then 4 
                                                 when b.opt_code in ('4468') then 5 
                                                 else 6 end as class,sum(amount) as amount
                            from  bass2.dw_product_201107 a, bass2.dw_acct_payment_dm_201107 b
                            where a.user_id=b.user_id and b.opt_code in ('4464','4864','4468','SJJF2','4115')
                            group by  a.region_id,
                                      case when b.opt_code in ('4464','4864') then 4 
                                                 when b.opt_code in ('4468') then 5 
                                                 else 6 end
                          )  a
                                    group by a.region_id,105,
                                             case when a.class = 4 then 205 
                                 when a.class = 5 then 201
                            else 206 end
        
insert into session.stat_market_channel_key_0133_tmp
                       select a.region_id,106,201,count(distinct login_product_no) as count
             from  bass2.dw_product_201107 a,bass2.dw_wcc_user_action_201107 b
             where b.login_product_no=a.product_no and b.login_type=1 and b.is_success=1
                   and a.userstatus_id>0
                   and date(b.login_time)>='2011-07-01' and date(b.login_time)<='2011-07-31'
             group by a.region_id
        
insert into session.stat_market_channel_key_0133_tmp
                       select b.region_id,106,202,count(distinct a.tel_calling)
                       from dw_custsvc_cps_log_call_dm_201107 a,
                            dw_product_201107 b
                        where a.tel_calling = b.product_no 
                                and a.tel_called = '10086'
                                             and b.userstatus_id in (1,2,3,6)
                       group by b.region_id
        
insert into session.stat_market_channel_key_0133_tmp
                       select b.region_id,106,203,count(distinct a.phone_id)
                       from  dw_kf_sms_cmd_receive_dm_201107 a,
                            dw_product_201107 b
                        where  a.phone_id = b.product_no 
                                                and b.userstatus_id in (1,2,3,6,8)
                       group by b.region_id
        
insert into session.stat_market_channel_key_0133_tmp
                   select d.region_id,106,204,count(distinct a.product_instance_id)
         from dw_product_ord_cust_dm_201107 a,
                      dw_product_ord_busi_dm_201107 b,
                      DW_PRODUCT_ORD_BUSI_OTHER_201107  c,
                                                   dw_product_201107 d
          where a.customer_order_id = b.customer_order_id
                      and b.busioper_order_id =c.busioper_order_id 
                      and c.ext_6 like '%SRC=206%'   
                                                   and a.product_instance_id = d.user_id     
                                  group by d.region_id 
        
insert into session.stat_market_channel_key_0133_tmp
                                 select b.region_id,106,205,count(distinct a.product_instance_id)
         from (select distinct product_instance_id
               from dw_product_ord_cust_dm_201107 
                           where channel_type='9'
               union 
               select distinct user_id as product_instance_id
               from dw_acct_payitem_dm_201107
               where paytype_id in ('4162','4864') ) a,
              dw_product_201107 b
         where a.product_instance_id = b.user_id
         group by  b.region_id
        
insert into session.stat_market_channel_key_0133_tmp
                   select b.region_id,107,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end,
                                                                           sum(a.flows)
from (
select echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,
         sum(flow) flows,product_no
      from (
            select 1 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (
      select 21 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  bass2.dw_custsvc_ivr_log_dm_201107
      where operation_code = '1008611' or operation_code = '20102'
      group by brand, calling
      union all
      select 23 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  bass2.dw_custsvc_ivr_log_dm_201107
      where operation_code = '20106'
      group by brand, calling
      union all
      select 24 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  bass2.dw_custsvc_ivr_log_dm_201107
      where operation_type <> 6
      group by brand, calling
               union all
      select 22 as busi_code_type, case when brand_name like '%全球通%' then 1
               when brand_name like '%动感地带%' then 4 else 5 end as brand_id,
       count(*) as flow, bill_id as product_no
      from  bass2.dw_product_ord_so_log_dm_201107
      where length(trim(char(op_id))) = 4
      and busi_id in (
      select business_id from  DIM_SO_BUSIOPTCODE_MAPPING where opt_name not like '%查询%')
      group by case when brand_name like '%全球通%' then 1
        when brand_name like '%动感地带%' then 4 else 5 end, bill_id
                 )a
            group by busi_code_type,brand_id,product_no
            union all
            select 2 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (select b.parent_ob_id as busi_code_type,a.brand_id,
                      count(1) as flow,a.product_no
                   from  bass2.dw_ow_loading_log_201107 a, dim_sys_object5  b
                   where a.ob_type =1 and b.parent_ob_id in (21,23) and b.check_result = 5 and a.ob_id = b.ob_id
                      and date(a.start_time)>='2011-07-01' and date(a.start_time)<'2011-07-31'
       and (a.is_success in (0,1) or a.err_msg is null
                   or a.err_msg = 'action is null' or a.err_msg = '您当前的营销方案无法变更该促销!'
                   or a.err_msg = '您输入的服务密码校验错误：密码不正确!' or a.err_msg = 'Broken pipe')
                   group by b.parent_ob_id,a.brand_id,a.product_no
                   union all
                   select 22 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  bass2.dw_product_busi_dm_201107 a, bass2.dw_product_201107 b
                   where a.user_id=b.user_id and a.user_id in (
                      select user_id from  bass2.dw_product_201107
                      where product_no in (select product_no from  bass2.dw_ow_loading_log_201107
                                           where is_success in (0,1) and date(start_time)>='2011-07-01' and date(start_time)<='2011-07-31'
                                           ) and userstatus_id>0
                      ) and a.so_mode ='15' and a.op_id=10000475
                      and date(a.so_date)>='2011-07-01' and date(a.so_date)<='2011-07-31'
                   group by b.brand_id,b.product_no
                   union all
                   select 24 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  bass2.dw_acct_payitem_dm_201107 a, bass2.dw_product_201107 b
                   where a.user_id=b.user_id and a.paytype_id in ('4468')
                   group by b.brand_id,b.product_no
                  )a
            group by busi_code_type,brand_id,product_no
            union all
   select 5 as echl_type,22 as busi_code_type,b.brand_id,b.product_no, count(1) as flow
   from  bass2.dw_product_ord_cust_dm_201107 a left join  bass2.dw_product_201107 b on a.product_instance_id=b.user_id
   where channel_type='6' and source_system_id in (3) and business_id=193000000001 and old_so_order_id is null
   group by b.brand_id, b.product_no
            union all
            select 6 as echl_type,24 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  bass2.dw_product_201107 a, bass2.dw_acct_payitem_dm_201107 b
            where a.user_id=b.user_id and b.paytype_id in ('4162','4864') and b.rec_sts=0
            group by a.brand_id,a.product_no
            union all
            select 6 as echl_type,22 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  bass2.dw_product_201107 a, bass2.dw_product_busi_dm_201107 b
            where a.user_id=b.user_id and b.so_mode='5' and b.op_id in (select op_id from  dim_boss_staff where op_name like '%自助%')
            and b.process_id not in (2,3,22,14,24,12,13)
            group by a.brand_id,a.product_no
           )a
      group by echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,product_no ) a ,
          bass2.dw_product_201107 b
          where  a.busi_code_type    in (23,21)
                and b.userstatus_id in (1,2,3,6,8)
                     and b.usertype_id in (1,2,9)
             and a.product_no = b.product_no
           group by b.region_id,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end
        
insert into session.stat_market_channel_key_0133_tmp
                select b.region_id,107,203,count(*)
                from 
                        dw_kf_sms_cmd_receive_dm_201107 a,
                                                     dw_product_201107 b
                where a.cmd_id in (     select distinct(cmd_id) 
                                                               from bass2.ODS_SYS_CMD_DEF_20110819
                                                                                                   where sts=0 and cmd_group in(9,10,20,12) 
                                                                                                       and fun_id <>100001 
                                                and cmd_desc  like '%查询%' 
                                                                                                        and cmd_type <>11  ) 
                                                and deal_result=0 
                                                and sts=4 
                                                and region_code <> 999
                                                and a.phone_id = b.product_no 
                                                and b.userstatus_id in (1,2,3,6,8)
                                                and b.usertype_id in (1,2,9)
                                                and a.cmd_id <> 201
                                group by  b.region_id
   
insert into session.stat_market_channel_key_0133_tmp
                      select value(c.region_id,'89199'),101,
                          case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end,
                                            count(1)

                     from
                     bass2.dw_product_busi_dm_201107 a,
                     bass2.dim_channel_info b,
                     bassweb.dim_pub_channel_ext c
                     where a.so_org_id = b.channel_id
                     and char(b.channel_id) = c.channel_id
                     group by value(c.region_id,'89199'),101,
                             case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end
        
insert into session.stat_market_channel_key_0133_tmp
                     select c.region_id,102,
                           case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end,
                                             count(1)

                    from
                    bass2.dw_product_busi_dm_201107 a,
                    bass2.dim_channel_info b,
                    bass2.dw_product_201107 c
                    where a.so_org_id = b.channel_id
                    and a.user_id = c.user_id
                    and a.busi_code in (1,4,5,99)
                    group by c.region_id,102,
                            case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end
        
insert into session.stat_market_channel_key_0133_tmp
                  select value(b.region_id,'89199'),103,
                            case when c.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when c.channel_type in (90881) then 208
                                             else 209 end,
                                             count(*)
                     from dw_res_ctms_exchg_201107 a
                          left join bassweb.dim_pub_channel_ext b on  a.org_id = b.channel_id
                          left join bass2.dim_channel_info c on b.channel_id = char(c.channel_id)
                     where a.sale_type like '%销售%'
                     group by value(b.region_id,'89199'),
                     case when c.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when c.channel_type in (90881) then 208
                                             else 209 end
                          
        
insert into session.stat_market_channel_key_0133_tmp
                                select value(c.region_id,'89199'),104,
                        case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end,
                                          count(1)

                    from
 (
 select b.product_instance_id,b.org_id from bass2.dw_product_ord_srvpkg_dm_201107 a,bass2.dw_product_ord_cust_dm_201107 b
 where 1=1 and a.customer_order_id=b.customer_order_id
    and a.servicepkg_id in (
 select PRODUCT_ITEM_ID from DIM_PROD_UP_PRODUCT_ITEM a where a.SUPPLIER_ID in ('931067','931067','931067','900119','900140','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900139','900139','900119','900652','900652','900652','900103','900103','900110','900110','900107','900122','900104','900104','900120','900120','900139','900139','900139','900139','900139','900139','900652','900652','900652','900652','900652','900652','900652','900652','900116','900105','900105','900113','900113','900123','900652','900652','900123','900123','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900109','900109','900109','900652','900652','901500','900139','900117','900117','900106','900106','900106','900106','900106','900112','900112','900140','900129','900121','900121','900121','900121','900121','900123','900123','900148','900652','900652','900652','900652','900652','900652','900652','900652','900141','900141','900141','900141','900143','900143','900143','900145','900145','900145','900143','900143','900143','900143','701001','701001','900132','900115','901899','900132','900132','901899','901899','931067','900114','901899','901899','901899','901899','701001','901899','901899','901899','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','701001','701001','701001','901876','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001',
 '701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901922','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001',
 '701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','900132','901876','901876','901876','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','931078','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001',
 '701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901908','900132','900132','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','80001','80001','80001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001',
 '701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801187','801187','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','80001','80001','80001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900128','900128','900128','900128','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','98555','931805','801132','801166','801166','801166','801166','801166','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801242','801242','801242','801173','801173','801173','801166','801166','801166','801166','801163','801163','801163','801151','701001','701001','701001','931067',
 '931067','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801151','801151','801151','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801236','801236','801236','801236','801236','901922','901922','801244','801244','801244','801137','801137','801137','801137','801137','801110','801110','801110','801110','801110','801110','801110','801110','801110','801110','801137','801137','801137','801137','801137','801137','801137','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801237','801237','801237','801237','801237','801233','801233','801233','900130','901585','901585','901585','801248','701001','701001','801248','801248','801248','801248','801248','801248','801185','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801187','900520','900520','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901500','701001','701001','701001','701001','701001','801164','801110','900144','900144','900144','701001','701001','931106','931106','931106','701001','801248','801248','801248','801248','801248','901585','901585','901585','801233','801233','801233','801233','801233','801185','801185','801114','801168','801168','801168','801164','801164','900138','900138','701001','701001','701001','701001','701001','701001','701001','801166','900013','900013','900013','900013','900013','900013','900138','900138','900139','900105','900132','900132','900132','900132','900132','900132','801248','801248','801166','801191','801191','801191','400000','400000','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900123','900123','900123','900123','900132','400000','400001','400001','400001','801157','900652','900132','900132','900132','900132','900652','801236','801236','801237','801237','801237','801236','801233','801233','801233','801233','801233','801233','801241','900132','900132','901876','900123','900123','900132','900132','900132','901876','901876','901585','901585','901585','900132','900132','900132','900132','901876','801157','801157','901876','901876','901876','901876','901876','901876','901876','901876','901876','931067','931067','931067','931067','931067','931067','931067','900013','900013','900013','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','931106') and item_type='SERVICE_PRICE')

 ) a,
 bass2.dim_channel_info b,
 bassweb.dim_pub_channel_ext c
 where a.org_id = b.channel_id
 and char(b.channel_id) = c.channel_id
group by value(c.region_id,'89199'),104,
        case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end
        
insert into session.stat_market_channel_key_0133_tmp
                          select value(c.region_id,'89199'),105,
                                case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                                           90154,90941,90156) and a.paytype_id in ('4101','4801','4132','GJFFZ','GJFKH','4103','GJFY1') then 207
                                                 when b.channel_type in (90175,90881,90886) and a.paytype_id in ('4101','4801','4132','GJFFZ','GJFKH','4103','GJFY1') then 208
                                                      when b.channel_type in (90177,90178,90885) and a.paytype_id in ('GJFg','gJFG','GJFG')then  209 
                                                      else  210 end,
                                                  sum(recv_cash)
                        from
                                  (select so_channel_id,paytype_id,sum(recv_cash) as recv_cash
                                   from bass2.dw_acct_payitem_dm_201107 
                                   where paytype_id in ('4101','4801','4132','GJFFZ','GJFKH','4103','GJFY1',
                                         'gJFG','GJFg','4158','GJFG')
                                   group by so_channel_id,paytype_id
                                   )a
                                   left join 
                                 bass2.dim_channel_info b on a.so_channel_id = b.channel_id
                                 left join 
                                 bassweb.dim_pub_channel_ext c on char(b.channel_id) = c.channel_id
                       group by value(c.region_id,'89199'),105,
                                  case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                                           90154,90941,90156) and a.paytype_id in ('4101','4801','4132','GJFFZ','GJFKH','4103','GJFY1') then 207
                                                 when b.channel_type in (90175,90881,90886) and a.paytype_id in ('4101','4801','4132','GJFFZ','GJFKH','4103','GJFY1') then 208
                                                      when b.channel_type in (90177,90178,90885) and a.paytype_id in ('GJFg','gJFG','GJFG')then  209 
                                                      else  210 end
        
insert into session.stat_market_channel_key_0133_tmp
                    select value(c.region_id,'89199'),106,
                           case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end,
                                          count(1)

                    from
                            bass2.dw_product_201107 a
                            left join 
                           bass2.dim_channel_info b on a.channel_id = b.channel_id
                           left join 
                           bassweb.dim_pub_channel_ext c on char(b.channel_id) = c.channel_id
                           where 
                            a.active_mark = 1
                    group by value(c.region_id,'89199'),106,
                               case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end
        
insert into session.stat_market_channel_key_0133_tmp
                                     select value(c.region_id,'89199'),107,
                              case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end,
                                                                          count(*)
                       from    bass2.dw_product_ord_so_log_dm_201107 a
                               left join 
                                    bass2.dim_channel_info b on a.org_id = b.channel_id
                                    left join 
                                    bassweb.dim_pub_channel_ext c on char(b.channel_id) = c.channel_id,
                                         dim_so_busioptcode_mapping d
                       where  
                            a.opt_code = d.opt_code
                              and d.opt_name like '%查询%'
                       group by  value(c.region_id,'89199'),107,
                                 case when b.channel_type in (90153,90155,90157,90158,90196,90940,90942,90943,
                              90154,90941,90156) then 207
                                         when b.channel_type in (90881) then 208
                                             else 209 end
        
insert into session.stat_market_channel_key_0133_tmp
                              select region_id,
                                     s_index_id,
                                     211,
                                     sum(value)
                              from session.stat_market_channel_key_0133_tmp
                              where s_index_id <> 106
                              group by region_id,s_index_id
        
insert into session.stat_market_channel_key_0133_tmp
                                    select region_id,
                                     s_index_id,
                                     211,
                                     sum(value)
                                  from session.stat_market_channel_key_0133_tmp
                                  where s_index_id = 106
                                      and t_index_id not in (201,202,203,204,205,206)
                                 group by region_id,s_index_id

        
delete from bass2.stat_market_channel_key_0133 where op_time = date('2011-07-01')
insert into bass2.stat_market_channel_key_0133
                                 select date('2011-07-01'),
                                                    case when grouping(b.city_id)=1 then '890' else b.city_id end,
                                                    case when grouping(c.region_id)=1 then '999' else c.region_id end,
                                                    a.s_index_id,
                                                    a.t_index_id,
                                                    sum(value)
                                 from  session.stat_market_channel_key_0133_tmp  a,
                                       bassweb.dim_pub_county b,
                                       bassweb.dim_pub_region c
                                 where a.region_id = c.region_id
                                   and c.county_id = b.county_id
                                 group by cube(b.city_id),
                                                    cube(c.region_id),
                                                    a.s_index_id,
                                                    a.t_index_id
                                 
0
报表程序完成!
