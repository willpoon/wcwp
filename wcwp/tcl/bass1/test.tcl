######################################################################################################
#接口名称：电子渠道关键数据日汇总
#接口编码：22066
#接口说明：记录所有电子渠道关键数据日汇总的信息。
#程序名称: G_S_22066_DAY.tcl
#功能描述: 生成22066的数据
#运行粒度: 月
#输入参数:
#输出参数: 返回值:0 成功;-1 失败
#编 写 人：PANZHIWEI
#编写时间：2011-06-10
#问题记录：
#修改历史: ref:22065
#######################################################################################################


 proc stat_market_channel_key_0133 {p_optime} {
 	 global conn
 	 global handle

# 	 source	stat_insert_index.tcl
# 	 source	report.cfg

 	 set	date_optime	[ai_to_date $p_optime]
 	 scan   $p_optime "%04s-%02s-%02s" year month day
 	 puts   $p_optime

	 #本月最后一天
	 set    last_day_month [GetLastDay [GetNextMonth $year$month]01]
	 puts   $last_day_month
	 scan  $last_day_month "%04s%02s%02s" lyear lmonth lday
	 puts  $lmonth

     #源表
   set dw_ow_loading_log_yyyymm               "bass2.dw_ow_loading_log_$year$month"
   set dw_custsvc_ivr_log_dm_yyyymm           "bass2.dw_custsvc_ivr_log_dm_$year$month"
   set dw_kf_sms_cmd_receive_dm_yyyymm        "bass2.dw_kf_sms_cmd_receive_dm_$year$month"
   set dw_product_ord_cust_dm_yyyymm          "bass2.dw_product_ord_cust_dm_$year$month"
   set dw_product_busi_dm_yyyymm              "bass2.dw_product_busi_dm_$year$month"
   set dw_product_yyyymm                      "bass2.dw_product_$year$month"
   set dw_acct_payitem_dm_yyyymm              "bass2.dw_acct_payitem_dm_$year$month"
   set dw_kf_sms_cmd_receive_dm_yyyymm        "bass2.dw_kf_sms_cmd_receive_dm_$year$month"
   set dw_kf_cmd_hint_def_dm_yyyymm           "bass2.dw_kf_cmd_hint_def_dm_$year$month"
   set dw_kf_sms_cmd_receive_dm_yyyymm        "bass2.dw_kf_sms_cmd_receive_dm_$year$month"
   set dw_product_ord_so_log_dm_yyyymm        "bass2.dw_product_ord_so_log_dm_$year$month"
   set dw_product_ord_srvpkg_dm_yyyymm        "bass2.dw_product_ord_srvpkg_dm_$year$month"
   set dw_wcc_user_action_yyyymm              "bass2.dw_wcc_user_action_$year$month"




    #边标签
    set dim_s_index_key_lkp    "bass2.dim_s_index_key_lkp"
    #顶标签
    set dim_t_index_key_lkp    "bass2.dim_t_index_key_lkp"
    #片区维表
     set dim_pub_region     "bassweb.dim_pub_region"
     #区县维表
     set dim_pub_county     "bassweb.dim_pub_county"
     #地市维表
     set dim_pub_city       "bassweb.dim_pub_city"

     #片区对应渠道关系
     set dim_pub_channel     "bassweb.dim_pub_channel"
     #渠道维表
     set dim_channel_info     "bass2.dim_channel_info"
     #指定专营店
     set    tmp_channel_type1  "90881"
     #特约代理点
     set    tmp_channel_type2  "90742,90883,90884,90153,90176,90177,90885"
     #自由营业厅
     set    tmp_channel_type3  "90157,90940"


     #指定专营店

     #结果表
     set   target_tab                   "bass2.stat_market_channel_key_0133"

     #创建临时结果表
		 set sql_buf "declare global temporary table session.stat_market_channel_key_0133_tmp (
              region_id   varchar(12),
              s_index_id  smallint,
              t_index_id  smallint,
              value       decimal(12,2)
          )
          partitioning key
        	(
        	  region_id
        	) using hashing
        with replace on commit preserve rows not logged in tbs_user_temp
        "
        puts $sql_buf


    #初始化临时表
    set sql_buf "insert into session.stat_market_channel_key_0133_tmp
                 select a.region_id,b.s_index_id,c.t_index_id,0
                 from $dim_pub_region a,
                      $dim_s_index_key_lkp  b,
                      $dim_t_index_key_lkp c
        "
        puts $sql_buf


   #1、业务办理量（不含充值交费，单位：笔）
       set sql_buf "insert into session.stat_market_channel_key_0133_tmp
           select  b.region_id,101,case when   a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 3 then 203
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end,
                                    sum(a.flows)
from (
select echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,
         sum(flow) flows,product_no
      from (
            select 1 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (
      select 21 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_code = '1008611' or operation_code = '20102'
      group by brand, calling
      union all
      select 23 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_code = '20106'
      group by brand, calling
      union all
      select 24 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_type <> 6
      group by brand, calling
               union all
      select 22 as busi_code_type, case when brand_name like '%全球通%' then 1
               when brand_name like '%动感地带%' then 4 else 5 end as brand_id,
       count(*) as flow, bill_id as product_no
      from  $dw_product_ord_so_log_dm_yyyymm
      where length(trim(char(op_id))) = 4
      and busi_id in (
      select business_id from  bass2.DIM_SO_BUSIOPTCODE_MAPPING where opt_name not like '%查询%')
      group by case when brand_name like '%全球通%' then 1
        when brand_name like '%动感地带%' then 4 else 5 end, bill_id
                 )a
            group by busi_code_type,brand_id,product_no
            union all
            select 2 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (select b.parent_ob_id as busi_code_type,a.brand_id,
                      count(1) as flow,a.product_no
                   from  $dw_ow_loading_log_yyyymm a, bass2.dim_sys_object5  b
                   where a.ob_type =1 and b.parent_ob_id in (21,23) and b.check_result = 5 and a.ob_id = b.ob_id
                      and date(a.start_time)>='$year-$month-01' and date(a.start_time)<='$lyear-$lmonth-$lday'
       and (a.is_success in (0,1) or a.err_msg is null
                   or a.err_msg = 'action is null' or a.err_msg = '您当前的营销方案无法变更该促销!'
                   or a.err_msg = '您输入的服务密码校验错误：密码不正确!' or a.err_msg = 'Broken pipe')
                   group by b.parent_ob_id,a.brand_id,a.product_no
                   union all
                   select 22 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  $dw_product_busi_dm_yyyymm a, $dw_product_yyyymm b
                   where a.user_id=b.user_id and a.user_id in (
                      select user_id from  $dw_product_yyyymm
                      where product_no in (select product_no from  $dw_ow_loading_log_yyyymm
                                           where is_success in (0,1) and date(start_time)>='$year-$month-01' and date(start_time)<='$lyear-$lmonth-$lday'
                                           ) and userstatus_id>0
                      ) and a.so_mode ='15' and a.op_id=10000475
                      and date(a.so_date)>='$year-$month-01' and date(a.so_date)<='$lyear-$lmonth-$lday'
                   group by b.brand_id,b.product_no
                   union all
                   select 24 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  $dw_acct_payitem_dm_yyyymm a, $dw_product_yyyymm b
                   where a.user_id=b.user_id and a.paytype_id in ('4468')
                   group by b.brand_id,b.product_no
                  )a
            group by busi_code_type,brand_id,product_no
            union all
            select 3 as echl_type,busi_code_type,brand_id,phone_id as product_no,sum(flow) as flow
            from (select case when c.result_type in ('CXYE','CXZD','CXZE','CXKCYE') then 21
            else 23 end as busi_code_type, a.brand_id,
             count(1) as flow, b.phone_id
      from  $dw_product_yyyymm a,  $dw_kf_sms_cmd_receive_dm_yyyymm b,  $dw_kf_cmd_hint_def_dm_yyyymm c
      where a.product_no  = b.phone_id and b.cmd_id = c.cmd_id and b.deal_result = c.cmd_result
      and replace(char(c.op_time),'-','') = '$lyear$lmonth$lday' and c.result_jieg in (0)
      and c.result_type in ('CXYE','CXZD','CXZE','CXKCYE','CXJF')
      and a.userstatus_id in (1,2,3,6,8) and a.test_mark <> 1 and a.usertype_id in (1,2,9)
      group by case when c.result_type in ('CXYE','CXZD','CXZE','CXKCYE') then 21
               else 23 end, a.brand_id, b.phone_id
      union all
      select 22 as busi_code_type, a.brand_id,
         count(1) as flow, b.phone_id
      from  $dw_product_yyyymm a,  $dw_kf_sms_cmd_receive_dm_yyyymm b,  $dw_kf_cmd_hint_def_dm_yyyymm c
      where a.product_no  = b.phone_id and b.cmd_id = c.cmd_id and b.deal_result = c.cmd_result
      and replace(char(c.op_time),'-','') = '$lyear$lmonth$lday' and c.result_jieg in (0)
      and c.result_type in (select sms_cmd from bass2.stat_ecustsvc_sms_cmd)
      and a.userstatus_id in (1,2,3,6,8) and a.test_mark <> 1 and a.usertype_id in (1,2,9)
      group by a.brand_id, b.phone_id) a
            group by busi_code_type,brand_id,phone_id
            union all
   select 5 as echl_type,22 as busi_code_type,b.brand_id,b.product_no, count(1) as flow
   from  $dw_product_ord_cust_dm_yyyymm a left join  $dw_product_yyyymm b on a.product_instance_id=b.user_id
   where channel_type='6' and source_system_id in (3) and business_id=193000000001 and old_so_order_id is null
   group by b.brand_id, b.product_no
            union all
            select 6 as echl_type,24 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  $dw_product_yyyymm a, $dw_acct_payitem_dm_yyyymm b
            where a.user_id=b.user_id and b.paytype_id in ('4162','4864') and b.rec_sts=0
            group by a.brand_id,a.product_no
            union all
            select 6 as echl_type,22 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  $dw_product_yyyymm a, $dw_product_busi_dm_yyyymm b
            where a.user_id=b.user_id and b.so_mode='5' and b.op_id in (select op_id from  bass2.dim_boss_staff where op_name like '%自助%')
            and b.process_id not in (2,3,22,14,24,12,13)
            group by a.brand_id,a.product_no
           )a
   group by echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,product_no ) a,
   $dw_product_yyyymm b
   where  a.busi_code_type   in (22)
     and b.userstatus_id in (1,2,3,6,8)
		     and b.usertype_id in (1,2,9)
             and a.product_no = b.product_no
   group by b.region_id,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 3 then 203
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end
        "
        puts $sql_buf


	  #增值业务办理
	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
                   select c.region_id,104,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 3 then 203
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end ,
									   count(a.product_no)
 from (
select echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,
         sum(flow) flows,product_no
      from (
            select 1 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (
      select 21 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_code = '1008611' or operation_code = '20102'
      group by brand, calling
      union all
      select 23 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_code = '20106'
      group by brand, calling
      union all
      select 24 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_type <> 6
      group by brand, calling
               union all
      select 22 as busi_code_type, case when brand_name like '%全球通%' then 1
               when brand_name like '%动感地带%' then 4 else 5 end as brand_id,
       count(*) as flow, bill_id as product_no
      from  $dw_product_ord_so_log_dm_yyyymm
      where length(trim(char(op_id))) = 4
      and busi_id in (
      select business_id from  bass2.DIM_SO_BUSIOPTCODE_MAPPING where opt_name not like '%查询%')
      group by case when brand_name like '%全球通%' then 1
        when brand_name like '%动感地带%' then 4 else 5 end, bill_id
                 )a
            group by busi_code_type,brand_id,product_no
            union all
            select 2 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (select b.parent_ob_id as busi_code_type,a.brand_id,
                      count(1) as flow,a.product_no
                   from  $dw_ow_loading_log_yyyymm a, bass2.dim_sys_object5  b
                   where a.ob_type =1 and b.parent_ob_id in (21,23) and b.check_result = 5 and a.ob_id = b.ob_id
                      and date(a.start_time)>='$year-$month-01' and date(a.start_time)<='$lyear-$lmonth-$lday'
       and (a.is_success in (0,1) or a.err_msg is null
                   or a.err_msg = 'action is null' or a.err_msg = '您当前的营销方案无法变更该促销!'
                   or a.err_msg = '您输入的服务密码校验错误：密码不正确!' or a.err_msg = 'Broken pipe')
                   group by b.parent_ob_id,a.brand_id,a.product_no
                   union all
                   select 22 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  $dw_product_busi_dm_yyyymm a, $dw_product_yyyymm b
                   where a.user_id=b.user_id and a.user_id in (
                      select user_id from  $dw_product_yyyymm
                      where product_no in (select product_no from  $dw_ow_loading_log_yyyymm
                                           where is_success in (0,1) and date(start_time)>='2010-12-01' and date(start_time)<'2011-01-01'
                                           ) and userstatus_id>0
                      ) and a.so_mode ='15' and a.op_id=10000475
                      and date(a.so_date)>='$year-$month-01' and date(a.so_date)<='$lyear-$lmonth-$lday'
                   group by b.brand_id,b.product_no
                   union all
                   select 24 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  $dw_acct_payitem_dm_yyyymm a, $dw_product_yyyymm b
                   where a.user_id=b.user_id and a.paytype_id in ('4468')
                   group by b.brand_id,b.product_no
                  )a
            group by busi_code_type,brand_id,product_no
            union all
            select 3 as echl_type,busi_code_type,brand_id,phone_id as product_no,sum(flow) as flow
            from (select case when c.result_type in ('CXYE','CXZD','CXZE','CXKCYE') then 21
            else 23 end as busi_code_type, a.brand_id,
             count(1) as flow, b.phone_id
      from  $dw_product_yyyymm a,  $dw_kf_sms_cmd_receive_dm_yyyymm b,  $dw_kf_cmd_hint_def_dm_yyyymm c
      where a.product_no  = b.phone_id and b.cmd_id = c.cmd_id and b.deal_result = c.cmd_result
      and replace(char(c.op_time),'-','') = '20101231' and c.result_jieg in (0)
      and c.result_type in ('CXYE','CXZD','CXZE','CXKCYE','CXJF')
      and a.userstatus_id in (1,2,3,6,8) and a.test_mark <> 1 and a.usertype_id in (1,2,9)
      group by case when c.result_type in ('CXYE','CXZD','CXZE','CXKCYE') then 21
               else 23 end, a.brand_id, b.phone_id
      union all
      select 22 as busi_code_type, a.brand_id,
         count(1) as flow, b.phone_id
      from  $dw_product_yyyymm a,  $dw_kf_sms_cmd_receive_dm_yyyymm b,  $dw_kf_cmd_hint_def_dm_yyyymm c
      where a.product_no  = b.phone_id and b.cmd_id = c.cmd_id and b.deal_result = c.cmd_result
      and replace(char(c.op_time),'-','') = '$lyear$lmonth$lday' and c.result_jieg in (0)
      and c.result_type in (select sms_cmd from bass2.stat_ecustsvc_sms_cmd)
      and a.userstatus_id in (1,2,3,6,8) and a.test_mark <> 1 and a.usertype_id in (1,2,9)
      group by a.brand_id, b.phone_id) a
            group by busi_code_type,brand_id,phone_id
            union all
   select 5 as echl_type,22 as busi_code_type,b.brand_id,b.product_no, count(1) as flow
   from  $dw_product_ord_cust_dm_yyyymm a left join  $dw_product_yyyymm b on a.product_instance_id=b.user_id
   where channel_type='6' and source_system_id in (3) and business_id=193000000001 and old_so_order_id is null
   group by b.brand_id, b.product_no
            union all
            select 6 as echl_type,24 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  $dw_product_yyyymm a, $dw_acct_payitem_dm_yyyymm b
            where a.user_id=b.user_id and b.paytype_id in ('4162','4864') and b.rec_sts=0
            group by a.brand_id,a.product_no
            union all
            select 6 as echl_type,22 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  $dw_product_yyyymm a, $dw_product_busi_dm_yyyymm b
            where a.user_id=b.user_id and b.so_mode='5' and b.op_id in (select op_id from  bass2.dim_boss_staff where op_name like '%自助%')
            and b.process_id not in (2,3,22,14,24,12,13)
            group by a.brand_id,a.product_no
           )a
      group by echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,product_no ) a,
	  (
select b.product_instance_id from $dw_product_ord_srvpkg_dm_yyyymm a,$dw_product_ord_cust_dm_yyyymm b
where 1=1 and a.customer_order_id=b.customer_order_id
   and a.servicepkg_id in (
select PRODUCT_ITEM_ID from bass2.DIM_PROD_UP_PRODUCT_ITEM a where a.SUPPLIER_ID in ('931067','931067','931067','900119','900140','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900139','900139','900119','900652','900652','900652','900103','900103','900110','900110','900107','900122','900104','900104','900120','900120','900139','900139','900139','900139','900139','900139','900652','900652','900652','900652','900652','900652','900652','900652','900116','900105','900105','900113','900113','900123','900652','900652','900123','900123','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900109','900109','900109','900652','900652','901500','900139','900117','900117','900106','900106','900106','900106','900106','900112','900112','900140','900129','900121','900121','900121','900121','900121','900123','900123','900148','900652','900652','900652','900652','900652','900652','900652','900652','900141','900141','900141','900141','900143','900143','900143','900145','900145','900145','900143','900143','900143','900143','701001','701001','900132','900115','901899','900132','900132','901899','901899','931067','900114','901899','901899','901899','901899','701001','901899','901899','901899','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','701001','701001','701001','901876','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901922','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','900132','901876','901876','901876','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','931078','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901908','900132','900132','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','80001','80001','80001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801187','801187','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','80001','80001','80001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900128','900128','900128','900128','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','98555','931805','801132','801166','801166','801166','801166','801166','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801242','801242','801242','801173','801173','801173','801166','801166','801166','801166','801163','801163','801163','801151','701001','701001','701001','931067','931067','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801151','801151','801151','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801236','801236','801236','801236','801236','901922','901922','801244','801244','801244','801137','801137','801137','801137','801137','801110','801110','801110','801110','801110','801110','801110','801110','801110','801110','801137','801137','801137','801137','801137','801137','801137','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801237','801237','801237','801237','801237','801233','801233','801233','900130','901585','901585','901585','801248','701001','701001','801248','801248','801248','801248','801248','801248','801185','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801187','900520','900520','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901500','701001','701001','701001','701001','701001','801164','801110','900144','900144','900144','701001','701001','931106','931106','931106','701001','801248','801248','801248','801248','801248','901585','901585','901585','801233','801233','801233','801233','801233','801185','801185','801114','801168','801168','801168','801164','801164','900138','900138','701001','701001','701001','701001','701001','701001','701001','801166','900013','900013','900013','900013','900013','900013','900138','900138','900139','900105','900132','900132','900132','900132','900132','900132','801248','801248','801166','801191','801191','801191','400000','400000','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900123','900123','900123','900123','900132','400000','400001','400001','400001','801157','900652','900132','900132','900132','900132','900652','801236','801236','801237','801237','801237','801236','801233','801233','801233','801233','801233','801233','801241','900132','900132','901876','900123','900123','900132','900132','900132','901876','901876','901585','901585','901585','900132','900132','900132','900132','901876','801157','801157','901876','901876','901876','901876','901876','901876','901876','901876','901876','931067','931067','931067','931067','931067','931067','931067','900013','900013','900013','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','931106') and item_type='SERVICE_PRICE')


) b,$dw_product_yyyymm c
where a.product_no=c.PRODUCT_NO and c.USER_ID=b.PRODUCT_INSTANCE_ID and a.busi_code_type     in (22)
     and c.userstatus_id in (1,2,3,6,8)
		     and c.usertype_id in (1,2,9)
	  group by  c.region_id,104,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 3 then 203
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end
        "
        puts $sql_buf



	      #充值缴费金额(单位:元)
	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
                     select a.region_id,105,case when a.class = 4 then 205 else 201 end ,sum(a.recv_cash)
		                 from
		                    ( select a.region_id,case when b.paytype_id in ('4162','4864') then 4 else 6 end as class,sum(recv_cash) as recv_cash
                            from  $dw_product_yyyymm a, $dw_acct_payitem_dm_yyyymm b
                            where a.user_id=b.user_id and b.paytype_id in ('4162','4864','4468')
                            group by  a.region_id,case when b.paytype_id in ('4162','4864') then 4 else 6 end )  a
		                    group by a.region_id,105,case when a.class = 4 then 205 else 201 end
        "
        puts $sql_buf


	  #登陆用户数
	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
	  	       select a.region_id,106,201,count(distinct login_product_no) as count
             from  $dw_product_yyyymm a,$dw_wcc_user_action_yyyymm b
             where b.login_product_no=a.product_no and b.login_type=1 and b.is_success=1
                   and a.userstatus_id>0
                   and date(b.login_time)>='$year-$month-01' and date(b.login_time)<='$lyear-$lmonth-$lday'
             group by a.region_id
        "
        puts $sql_buf


	  #业务查询量(笔)
	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
                   select b.region_id,107,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 3 then 203
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end,
									   sum(a.flows)
from (
select echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,
         sum(flow) flows,product_no
      from (
            select 1 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (
      select 21 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_code = '1008611' or operation_code = '20102'
      group by brand, calling
      union all
      select 23 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_code = '20106'
      group by brand, calling
      union all
      select 24 as busi_code_type, brand as brand_id, count(*) as flow, calling as product_no
      from  $dw_custsvc_ivr_log_dm_yyyymm
      where operation_type <> 6
      group by brand, calling
               union all
      select 22 as busi_code_type, case when brand_name like '%全球通%' then 1
               when brand_name like '%动感地带%' then 4 else 5 end as brand_id,
       count(*) as flow, bill_id as product_no
      from  $dw_product_ord_so_log_dm_yyyymm
      where length(trim(char(op_id))) = 4
      and busi_id in (
      select business_id from  bass2.DIM_SO_BUSIOPTCODE_MAPPING where opt_name not like '%查询%')
      group by case when brand_name like '%全球通%' then 1
        when brand_name like '%动感地带%' then 4 else 5 end, bill_id
                 )a
            group by busi_code_type,brand_id,product_no
            union all
            select 2 as echl_type,busi_code_type,brand_id,product_no,sum(flow) as flow
            from (select b.parent_ob_id as busi_code_type,a.brand_id,
                      count(1) as flow,a.product_no
                   from  $dw_ow_loading_log_yyyymm a, bass2.dim_sys_object5  b
                   where a.ob_type =1 and b.parent_ob_id in (21,23) and b.check_result = 5 and a.ob_id = b.ob_id
                      and date(a.start_time)>='$year-$month-$day' and date(a.start_time)<'$lyear-$lmonth-$lday'
       and (a.is_success in (0,1) or a.err_msg is null
                   or a.err_msg = 'action is null' or a.err_msg = '您当前的营销方案无法变更该促销!'
                   or a.err_msg = '您输入的服务密码校验错误：密码不正确!' or a.err_msg = 'Broken pipe')
                   group by b.parent_ob_id,a.brand_id,a.product_no
                   union all
                   select 22 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  $dw_product_busi_dm_yyyymm a, $dw_product_yyyymm b
                   where a.user_id=b.user_id and a.user_id in (
                      select user_id from  $dw_product_yyyymm
                      where product_no in (select product_no from  $dw_ow_loading_log_yyyymm
                                           where is_success in (0,1) and date(start_time)>='$year-$month-$day' and date(start_time)<='$lyear-$lmonth-$lday'
                                           ) and userstatus_id>0
                      ) and a.so_mode ='15' and a.op_id=10000475
                      and date(a.so_date)>='$year-$month-$day' and date(a.so_date)<='$lyear-$lmonth-$lday'
                   group by b.brand_id,b.product_no
                   union all
                   select 24 as busi_code_type,b.brand_id,count(1) as flow,b.product_no
                   from  $dw_acct_payitem_dm_yyyymm a, $dw_product_yyyymm b
                   where a.user_id=b.user_id and a.paytype_id in ('4468')
                   group by b.brand_id,b.product_no
                  )a
            group by busi_code_type,brand_id,product_no
            union all
            select 3 as echl_type,busi_code_type,brand_id,phone_id as product_no,sum(flow) as flow
            from (select case when c.result_type in ('CXYE','CXZD','CXZE','CXKCYE') then 21
            else 23 end as busi_code_type, a.brand_id,
             count(1) as flow, b.phone_id
      from  $dw_product_yyyymm a,  $dw_kf_sms_cmd_receive_dm_yyyymm b,  $dw_kf_cmd_hint_def_dm_yyyymm c
      where a.product_no  = b.phone_id and b.cmd_id = c.cmd_id and b.deal_result = c.cmd_result
      and replace(char(c.op_time),'-','') = '20101231' and c.result_jieg in (0)
      and c.result_type in ('CXYE','CXZD','CXZE','CXKCYE','CXJF')
      and a.userstatus_id in (1,2,3,6,8) and a.test_mark <> 1 and a.usertype_id in (1,2,9)
      group by case when c.result_type in ('CXYE','CXZD','CXZE','CXKCYE') then 21
               else 23 end, a.brand_id, b.phone_id
      union all
      select 22 as busi_code_type, a.brand_id,
         count(1) as flow, b.phone_id
      from  $dw_product_yyyymm a,  $dw_kf_sms_cmd_receive_dm_yyyymm b,  $dw_kf_cmd_hint_def_dm_yyyymm c
      where a.product_no  = b.phone_id and b.cmd_id = c.cmd_id and b.deal_result = c.cmd_result
      and replace(char(c.op_time),'-','') = '$lyear$lmonth$lday' and c.result_jieg in (0)
      and c.result_type in (select sms_cmd from bass2.stat_ecustsvc_sms_cmd)
      and a.userstatus_id in (1,2,3,6,8) and a.test_mark <> 1 and a.usertype_id in (1,2,9)
      group by a.brand_id, b.phone_id) a
            group by busi_code_type,brand_id,phone_id
            union all
   select 5 as echl_type,22 as busi_code_type,b.brand_id,b.product_no, count(1) as flow
   from  $dw_product_ord_cust_dm_yyyymm a left join  $dw_product_yyyymm b on a.product_instance_id=b.user_id
   where channel_type='6' and source_system_id in (3) and business_id=193000000001 and old_so_order_id is null
   group by b.brand_id, b.product_no
            union all
            select 6 as echl_type,24 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  $dw_product_yyyymm a, $dw_acct_payitem_dm_yyyymm b
            where a.user_id=b.user_id and b.paytype_id in ('4162','4864') and b.rec_sts=0
            group by a.brand_id,a.product_no
            union all
            select 6 as echl_type,22 as busi_code_type,a.brand_id,a.product_no,count(1) as flow
            from  $dw_product_yyyymm a, $dw_product_busi_dm_yyyymm b
            where a.user_id=b.user_id and b.so_mode='5' and b.op_id in (select op_id from  bass2.dim_boss_staff where op_name like '%自助%')
            and b.process_id not in (2,3,22,14,24,12,13)
            group by a.brand_id,a.product_no
           )a
      group by echl_type,busi_code_type,case brand_id when 1 then 1 when 4 then 2 else 3 end,product_no ) a ,
	  $dw_product_yyyymm b
	  where  a.busi_code_type    in (23,21)
	        and b.userstatus_id in (1,2,3,6,8)
		     and b.usertype_id in (1,2,9)
             and a.product_no = b.product_no
	   group by b.region_id,
                   case when a.echl_type = 1 then 202
                                       when a.echl_type = 2 then 201
                                       when a.echl_type = 3 then 203
                                       when a.echl_type = 5 then 204
                                       when a.echl_type = 6 then 205
                                       else 206 end
        "
        puts $sql_buf

	  #统计自有渠道----业务办理量（不含充值交费，单位：笔）
	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
                      select c.region_id,101,
                          case when b.channel_type in (90157,90940) then 207
		                        when b.channel_type in (90881) then 208
			                    when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
			                    else 210 end,
			                    count(1)

                     from
                     $dw_product_busi_dm_yyyymm a,
                     bass2.dim_channel_info b,
                     bassweb.dim_pub_channel c
                     where a.so_org_id = b.channel_id
                     and char(b.channel_id) = c.channel_id
                     group by c.region_id,101,
                             case when b.channel_type in (90157,90940) then 207
                     		      when b.channel_type in (90881) then 208
                     			  when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
                     			  else 210 end
        "
        puts $sql_buf


	  #卡号销售量
	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
                     select c.region_id,102,
                           case when b.channel_type in (90157,90940) then 207
		                         when b.channel_type in (90881) then 208
			                     when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
			                     else 210 end,
			                     count(1)

                    from
                    $dw_product_busi_dm_yyyymm a,
                    bass2.dim_channel_info b,
                    bassweb.dim_pub_channel c
                    where a.so_org_id = b.channel_id
                    and char(b.channel_id) = c.channel_id
                    and a.busi_code in (1,4,5,99)
                    group by c.region_id,102,
                            case when b.channel_type in (90157,90940) then 207
                    		      when b.channel_type in (90881) then 208
                    			  when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
                    			  else 210 end
        "
        puts $sql_buf


	  #增值业务办理量
	  	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
	  	  	        select c.region_id,104,
                        case when b.channel_type in (90157,90940) then 207
		                      when b.channel_type in (90881) then 208
			                  when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
			                  else 210 end,
			                  count(1)

                    from
 (
 select b.product_instance_id,b.org_id from $dw_product_ord_srvpkg_dm_yyyymm a,$dw_product_ord_cust_dm_yyyymm b
 where 1=1 and a.customer_order_id=b.customer_order_id
    and a.servicepkg_id in (
 select PRODUCT_ITEM_ID from bass2.DIM_PROD_UP_PRODUCT_ITEM a where a.SUPPLIER_ID in ('931067','931067','931067','900119','900140','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900139','900139','900119','900652','900652','900652','900103','900103','900110','900110','900107','900122','900104','900104','900120','900120','900139','900139','900139','900139','900139','900139','900652','900652','900652','900652','900652','900652','900652','900652','900116','900105','900105','900113','900113','900123','900652','900652','900123','900123','900652','900652','900652','900652','900652','900652','900652','900652','900652','900652','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900118','900109','900109','900109','900652','900652','901500','900139','900117','900117','900106','900106','900106','900106','900106','900112','900112','900140','900129','900121','900121','900121','900121','900121','900123','900123','900148','900652','900652','900652','900652','900652','900652','900652','900652','900141','900141','900141','900141','900143','900143','900143','900145','900145','900145','900143','900143','900143','900143','701001','701001','900132','900115','901899','900132','900132','901899','901899','931067','900114','901899','901899','901899','901899','701001','901899','901899','901899','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','901876','701001','701001','701001','901876','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001',
 '701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901922','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001',
 '701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','900132','901876','901876','901876','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','931078','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001',
 '701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901908','900132','900132','900132','900132','900132','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900132','900132','900132','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','80001','80001','80001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001',
 '701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801187','801187','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','80001','80001','80001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','900128','900128','900128','900128','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','98555','931805','801132','801166','801166','801166','801166','801166','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801242','801242','801242','801173','801173','801173','801166','801166','801166','801166','801163','801163','801163','801151','701001','701001','701001','931067',
 '931067','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801151','801151','801151','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801236','801236','801236','801236','801236','901922','901922','801244','801244','801244','801137','801137','801137','801137','801137','801110','801110','801110','801110','801110','801110','801110','801110','801110','801110','801137','801137','801137','801137','801137','801137','801137','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801237','801237','801237','801237','801237','801233','801233','801233','900130','901585','901585','901585','801248','701001','701001','801248','801248','801248','801248','801248','801248','801185','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801137','801187','900520','900520','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','901500','701001','701001','701001','701001','701001','801164','801110','900144','900144','900144','701001','701001','931106','931106','931106','701001','801248','801248','801248','801248','801248','901585','901585','901585','801233','801233','801233','801233','801233','801185','801185','801114','801168','801168','801168','801164','801164','900138','900138','701001','701001','701001','701001','701001','701001','701001','801166','900013','900013','900013','900013','900013','900013','900138','900138','900139','900105','900132','900132','900132','900132','900132','900132','801248','801248','801166','801191','801191','801191','400000','400000','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900132','900123','900123','900123','900123','900132','400000','400001','400001','400001','801157','900652','900132','900132','900132','900132','900652','801236','801236','801237','801237','801237','801236','801233','801233','801233','801233','801233','801233','801241','900132','900132','901876','900123','900123','900132','900132','900132','901876','901876','901585','901585','901585','900132','900132','900132','900132','901876','801157','801157','901876','901876','901876','901876','901876','901876','901876','901876','901876','931067','931067','931067','931067','931067','931067','931067','900013','900013','900013','901876','901876','901876','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','701001','931106') and item_type='SERVICE_PRICE')

 ) a,
 bass2.dim_channel_info b,
 bassweb.dim_pub_channel c
 where a.org_id = b.channel_id
 and char(b.channel_id) = c.channel_id
group by c.region_id,104,
        case when b.channel_type in (90157,90940) then 207
		      when b.channel_type in (90881) then 208
			  when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
			  else 210 end

        "
        puts $sql_buf


	  #充值缴费金额
	  	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
                          select c.region_id,105,
                                case when b.channel_type in (90157,90940) then 207
		                              when b.channel_type in (90881) then 208
			                          when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
			                          else 210 end,
			                          sum(recv_cash)
                        from
                         $dw_acct_payitem_dm_yyyymm a,
                        bass2.dim_channel_info b,
                        bassweb.dim_pub_channel c
                        where a.so_channel_id = b.channel_id
                        and char(b.channel_id) = c.channel_id
                       group by c.region_id,105,
                               case when b.channel_type in (90157,90940) then 207
                       		      when b.channel_type in (90881) then 208
                       			  when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
                       			  else 210 end
        "
        puts $sql_buf


	  #登陆用户数
	  	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
                    select c.region_id,106,
                        case when b.channel_type in (90157,90940) then 207
		                      when b.channel_type in (90881) then 208
			                  when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
			                  else 210 end,
			                  count(1)

                    from
                            $dw_product_yyyymm a,
                           bass2.dim_channel_info b,
                           bassweb.dim_pub_channel c
                           where a.channel_id = b.channel_id
                           and char(b.channel_id) = c.channel_id
                           and a.active_mark = 1
                    group by c.region_id,106,
                            case when b.channel_type in (90157,90940) then 207
                    		      when b.channel_type in (90881) then 208
                    			  when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
                    			  else 210 end
        "
        puts $sql_buf


	  #业务查询量
	  	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
	  	  	             select c.region_id,107,
                              case when b.channel_type in (90157,90940) then 207
		                               when b.channel_type in (90881) then 208
			                             when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
			                              else 210 end,
							                  count(*)
                       from    $dw_product_ord_so_log_dm_yyyymm a,
                                    bass2.dim_channel_info b,
                                    bassweb.dim_pub_channel c,
                       			 bass2.dim_so_busioptcode_mapping d
                       where  a.org_id = b.channel_id
                       	   and char(b.channel_id) = c.channel_id
                              and a.opt_code = d.opt_code
                              and d.opt_name like '%查询%'
                       group by  c.region_id,107,
                                                   case when b.channel_type in (90157,90940) then 207
                                           		      when b.channel_type in (90881) then 208
                                           			  when  b.channel_type in (90742,90883,90884,90153,90176,90177,90885) then 209
                                           			  else 210 end
        "
        puts $sql_buf



	  #全渠道数据入临时表
	  	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
	  	  	      select region_id,
	  	  	             s_index_id,
	  	  	             211,
	  	  	             sum(value)
	  	  	      from session.stat_market_channel_key_0133_tmp
	  	  	      where s_index_id <> 106
	  	  	      group by region_id,s_index_id
        "
        puts $sql_buf


	  	  	   set sql_buf "insert into session.stat_market_channel_key_0133_tmp
	  	  	            select region_id,
	  	  	             s_index_id,
	  	  	             211,
	  	  	             sum(value)
	  	  	          from session.stat_market_channel_key_0133_tmp
	  	  	          where s_index_id = 106
	  	  	              and t_index_id not in (201,202,203,204,205,206)
	  	  	         group by region_id,s_index_id

        "
        puts $sql_buf

#=================================================================================================
  	set sal_buf00 "delete from $target_tab where op_time = $date_optime"
       puts $sal_buf00

	#将临时表数据插入结果表
    set sql_buf "insert into $target_tab
				 select $date_optime,
						    case when grouping(b.city_id)=1 then '890' else b.city_id end,
						    case when grouping(c.region_id)=1 then '999' else c.region_id end,
						    a.s_index_id,
						    a.t_index_id,
						    sum(value)
				 from  session.stat_market_channel_key_0133_tmp  a,
				       bassweb.dim_pub_county b,
				       bassweb.dim_pub_region c
				 where a.region_id = c.region_id
				   and c.county_id = b.county_id
				 group by cube(b.city_id),
						    cube(c.region_id),
						    a.s_index_id,
						    a.t_index_id
				 "
		 puts $sql_buf


	return 0
}


proc Deal { op_time optime_month province_id redo_number trace_fd bass1_dir temp_data_dir semi_data_dir final_data_dir conn conn_ctl src_data obj_data final_data } {
set op_time 2011-04-01

   #当天 yyyymmdd
    set timestamp [string range $op_time 0 3][string range $op_time 5 6][string range $op_time 8 9]

    #当天 yyyy-mm-dd
    set optime $op_time

    #本月 yyyymm
    set op_month [string range $optime_month 0 3][string range $optime_month 5 6]
    puts $op_month

    #本月第一天 yyyy-mm-dd
    set this_month_first_day [string range $op_month 0 3][string range $op_time 4 4][string range $op_month 4 5][string range $op_time 4 4]01
    puts $this_month_first_day
		#自然月
		set curr_month [string range $op_time 0 3][string range $op_time 5 6]
    #本月最后一天 yyyy-mm-dd
    set this_month_last_day [string range $op_month 0 3][string range $op_time 4 4][string range $op_month 4 5][string range $op_time 4 4][GetThisMonthDays [string range $op_month 0 5]01]
    puts $this_month_last_day
		global app_name
		set app_name "G_S_22066_DAY.tcl"        

	 set p_optime $op_time
 	 set	date_optime	[ai_to_date $p_optime]
 	 scan   $p_optime "%04s-%02s-%02s" year month day
 	 puts   $p_optime

	 #本月最后一天
	 set    last_day_month [GetLastDay [GetNextMonth $year$month]01]
	 puts   $last_day_month
	 scan  $last_day_month "%04s%02s%02s" lyear lmonth lday
	 puts  $lmonth


     #源表
   set dw_ow_loading_log_yyyymm               "bass2.dw_ow_loading_log_$year$month"
   set dw_custsvc_ivr_log_dm_yyyymm           "bass2.dw_custsvc_ivr_log_dm_$year$month"
   set dw_kf_sms_cmd_receive_dm_yyyymm        "bass2.dw_kf_sms_cmd_receive_dm_$year$month"
   set dw_product_ord_cust_dm_yyyymm          "bass2.dw_product_ord_cust_dm_$year$month"
   set dw_product_busi_dm_yyyymm              "bass2.dw_product_busi_dm_$year$month"
   set dw_product_yyyymm                      "bass2.dw_product_$year$month"
   set dw_acct_payitem_dm_yyyymm              "bass2.dw_acct_payitem_dm_$year$month"
   set dw_kf_sms_cmd_receive_dm_yyyymm        "bass2.dw_kf_sms_cmd_receive_dm_$year$month"
   set dw_kf_cmd_hint_def_dm_yyyymm           "bass2.dw_kf_cmd_hint_def_dm_$year$month"
   set dw_kf_sms_cmd_receive_dm_yyyymm        "bass2.dw_kf_sms_cmd_receive_dm_$year$month"
   set dw_product_ord_so_log_dm_yyyymm        "bass2.dw_product_ord_so_log_dm_$year$month"
   set dw_product_ord_srvpkg_dm_yyyymm        "bass2.dw_product_ord_srvpkg_dm_$year$month"
   set dw_wcc_user_action_yyyymm              "bass2.dw_wcc_user_action_$year$month"

	stat_market_channel_key_0133 2011-04-01
	
	return 0

}

#T_INDEX_ID	T_NAME	T_INDEX_NAME	SEQ
#201	电子渠道	网站	1
#202	电子渠道	热线	2
#203	电子渠道	短信	3
#204	电子渠道	WAP	4
#205	电子渠道	自助终端	5
#206	电子渠道	其它	6
#207	实体渠道	自有营业厅	7
#208	实体渠道	指定专营店	8
#209	实体渠道	特约代理点	9
#210	实体渠道	其它	10
#211	全渠道	全渠道	11


#S_INDEX_ID	S_INDEX_NAME	SEQ
#101	1、业务办理量(不含充值交费，单位：笔)	1
#102	&nbsp;&nbsp;&nbsp;&nbsp;卡号销 	2
#103	&nbsp;&nbsp;&nbsp;&nbsp;终端销 	3
#104	&nbsp;&nbsp;&nbsp;&nbsp;增值业务办理量	4
#105	2、充值交费金额(单位：元)	5
#106	3、登陆用户数	6
#107	4、业务查询量(笔)	7
